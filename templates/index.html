<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­ç›‘æ§æˆªå›¾æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ ç›´æ’­ç›‘æ§æˆªå›¾æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <p class="subtitle">è¾“å…¥IDæˆ–ç¼–å·æœç´¢æ‚¨çš„æˆªå›¾</p>
        </header>

        <div class="search-section">
            <div class="search-box">
                <select id="searchType" class="search-type-select" onchange="onSearchTypeChange()">
                    <option value="auto">è‡ªåŠ¨è¯†åˆ«</option>
                    <option value="id">æŒ‰IDæœç´¢</option>
                    <option value="serial">æŒ‰ç¼–å·æœç´¢</option>
                    <option value="date">æŒ‰æ—¥æœŸæœç´¢</option>
                </select>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="è¯·è¾“å…¥IDæˆ–ç¼–å·" 
                    autocomplete="off"
                    style="display: block;"
                >
                <input 
                    type="date" 
                    id="dateInput" 
                    style="display: none;"
                >
                <button id="searchBtn" onclick="searchImages()">ğŸ” æœç´¢</button>
            </div>
            <div class="stats" id="stats">
                <span id="totalImages">æ€»å›¾ç‰‡æ•°: åŠ è½½ä¸­...</span>
            </div>
        </div>

        <!-- æˆªå›¾é€Ÿåº¦ç»Ÿè®¡å›¾è¡¨ -->
        <div class="chart-section" id="chartSection">
            <div class="chart-header">
                <h2>ğŸ“Š æˆªå›¾é€Ÿåº¦ç»Ÿè®¡ï¼ˆæ¯20åˆ†é’Ÿï¼ŒæŒ‰æ—¥æœŸåˆ†ç±»ï¼‰</h2>
                <div class="chart-controls">
                    <select id="dateSelector" class="date-select" onchange="loadChart()">
                        <option value="">é€‰æ‹©æ—¥æœŸ...</option>
                    </select>
                    <button id="refreshChart" onclick="loadChart()" class="refresh-btn">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h2 id="resultsTitle">æœç´¢ç»“æœ</h2>
                <span id="resultsCount" class="count-badge"></span>
            </div>
            <div id="resultsContainer" class="results-container">
                <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ“·</div>
            <p>è¯·è¾“å…¥IDæˆ–ç¼–å·è¿›è¡Œæœç´¢</p>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æœç´¢ä¸­...</p>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
            <div class="image-info">
                <p><strong>ID:</strong> <span id="modalId"></span></p>
                <p><strong>ç¼–å·:</strong> <span id="modalSerial"></span></p>
                <p><strong>æ—¥æœŸ:</strong> <span id="modalDate"></span></p>
                <p><strong>ä¸Šä¼ æ—¶é—´:</strong> <span id="modalTime"></span></p>
            </div>
        </div>
    </div>

    <script>
        // å›¾è¡¨å®ä¾‹
        let speedChart = null;

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡ä¿¡æ¯
        window.onload = function() {
            loadStats();
            loadChart();
            // å›è½¦æœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchImages();
                }
            });
            document.getElementById('dateInput').addEventListener('change', function() {
                // æ—¥æœŸæ”¹å˜æ—¶è‡ªåŠ¨æœç´¢
                if (this.value) {
                    searchImages();
                }
            });
        };

        // æœç´¢ç±»å‹æ”¹å˜æ—¶çš„å¤„ç†
        function onSearchTypeChange() {
            const searchType = document.getElementById('searchType').value;
            const searchInput = document.getElementById('searchInput');
            const dateInput = document.getElementById('dateInput');
            
            if (searchType === 'date') {
                searchInput.style.display = 'none';
                dateInput.style.display = 'block';
                dateInput.focus();
            } else {
                searchInput.style.display = 'block';
                dateInput.style.display = 'none';
                searchInput.placeholder = searchType === 'id' ? 'è¯·è¾“å…¥ID' : 
                                         searchType === 'serial' ? 'è¯·è¾“å…¥ç¼–å·' : 
                                         'è¯·è¾“å…¥IDæˆ–ç¼–å·';
                searchInput.focus();
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                document.getElementById('totalImages').textContent = `æ€»å›¾ç‰‡æ•°: ${data.total_images} | IDæ•°é‡: ${data.total_ids}`;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æœç´¢å›¾ç‰‡
        async function searchImages() {
            const searchType = document.getElementById('searchType').value;
            let query = '';
            let dateFilter = '';
            
            if (searchType === 'date') {
                dateFilter = document.getElementById('dateInput').value;
                if (!dateFilter) {
                    alert('è¯·é€‰æ‹©æ—¥æœŸ');
                    return;
                }
            } else {
                query = document.getElementById('searchInput').value.trim();
                if (!query) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                let url = `/api/search?type=${encodeURIComponent(searchType)}`;
                if (query) {
                    url += `&q=${encodeURIComponent(query)}`;
                }
                if (dateFilter) {
                    url += `&date=${encodeURIComponent(dateFilter)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (data.error) {
                    alert(data.error);
                    return;
                }

                if (data.count === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('emptyState').innerHTML = `
                        <div class="empty-icon">ğŸ”</div>
                        <p>æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡</p>
                        <p class="empty-hint">è¯·æ£€æŸ¥IDæˆ–ç¼–å·æ˜¯å¦æ­£ç¡®</p>
                    `;
                    return;
                }

                // æ˜¾ç¤ºç»“æœ
                displayResults(data);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert('æœç´¢å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(data) {
            let typeText = '';
            let queryText = '';
            
            if (data.type === 'id') {
                typeText = 'ï¼ˆæŒ‰IDï¼‰';
                queryText = data.query;
            } else if (data.type === 'serial') {
                typeText = 'ï¼ˆæŒ‰ç¼–å·ï¼‰';
                queryText = data.query;
            } else if (data.type === 'date') {
                typeText = 'ï¼ˆæŒ‰æ—¥æœŸï¼‰';
                queryText = data.date_filter || data.query;
            } else {
                typeText = 'ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰';
                queryText = data.query;
            }
            
            document.getElementById('resultsTitle').textContent = `æœç´¢ç»“æœ: "${queryText}" ${typeText}`;
            document.getElementById('resultsCount').textContent = `æ‰¾åˆ° ${data.count} å¼ å›¾ç‰‡`;
            document.getElementById('resultsSection').style.display = 'block';

            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            data.results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <div class="image-wrapper" onclick="showModal('${item.path}', '${item.id}', '${item.serial_number}', '${item.date}', '${item.modified}')">
                        <img src="/api/images/${item.path}" alt="${item.filename}" loading="lazy">
                        <div class="image-overlay">
                            <span class="view-btn">ğŸ‘ï¸ æŸ¥çœ‹å¤§å›¾</span>
                        </div>
                    </div>
                    <div class="image-details">
                        <div class="detail-item">
                            <span class="label">ID:</span>
                            <span class="value">${item.id}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">ç¼–å·:</span>
                            <span class="value">${item.serial_number}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">æ—¥æœŸ:</span>
                            <span class="value">${item.date}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
        function showModal(imagePath, id, serial, date, time) {
            document.getElementById('modalImage').src = `/api/images/${imagePath}`;
            document.getElementById('modalId').textContent = id;
            document.getElementById('modalSerial').textContent = serial;
            document.getElementById('modalDate').textContent = date;
            document.getElementById('modalTime').textContent = time;
            document.getElementById('imageModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // åŠ è½½å›¾è¡¨æ•°æ®
        async function loadChart() {
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();

                console.log('API è¿”å›æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯

                // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
                const dateSelector = document.getElementById('dateSelector');
                let selectedDate = dateSelector.value; // ä¿å­˜å½“å‰é€‰æ‹©
                
                if (data.dates && data.dates.length > 0) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"é€‰æ‹©æ—¥æœŸ..."é€‰é¡¹ï¼‰
                    const firstOption = dateSelector.options[0];
                    dateSelector.innerHTML = '';
                    dateSelector.appendChild(firstOption);
                    
                    // æ·»åŠ æ—¥æœŸé€‰é¡¹
                    data.dates.forEach(date => {
                        const option = document.createElement('option');
                        const dateParts = date.split('-');
                        option.value = date;
                        option.textContent = `${dateParts[1]}-${dateParts[2]}`;
                        dateSelector.appendChild(option);
                    });
                    
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (!selectedDate && data.dates.length > 0) {
                        selectedDate = data.dates[0];
                        dateSelector.value = selectedDate;
                    } else if (selectedDate) {
                        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                        dateSelector.value = selectedDate;
                    }
                }

                // è·å–é€‰ä¸­çš„æ—¥æœŸï¼ˆä½¿ç”¨æ›´æ–°åçš„å€¼ï¼‰
                selectedDate = dateSelector.value;
                console.log('é€‰ä¸­çš„æ—¥æœŸ:', selectedDate); // è°ƒè¯•ä¿¡æ¯
                
                if (selectedDate && data.by_date && data.by_date[selectedDate]) {
                    const dateData = data.by_date[selectedDate];
                    console.log('æ—¥æœŸæ•°æ®:', dateData); // è°ƒè¯•ä¿¡æ¯
                    drawSpeedChart(dateData, selectedDate);
                } else if (selectedDate) {
                    console.log('é€‰ä¸­æ—¥æœŸæ²¡æœ‰æ•°æ®:', selectedDate);
                    // æ¸…ç©ºå›¾è¡¨
                    if (speedChart) {
                        speedChart.destroy();
                        speedChart = null;
                    }
                } else {
                    console.log('æ²¡æœ‰é€‰æ‹©æ—¥æœŸ');
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸä½†æœ‰æ•°æ®ï¼Œå°è¯•è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (data.dates && data.dates.length > 0 && !selectedDate) {
                        console.log('è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ—¥æœŸ:', data.dates[0]);
                        dateSelector.value = data.dates[0];
                        selectedDate = data.dates[0];
                        if (data.by_date && data.by_date[selectedDate]) {
                            const dateData = data.by_date[selectedDate];
                            console.log('æ—¥æœŸæ•°æ®:', dateData);
                            drawSpeedChart(dateData, selectedDate);
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
            }
        }

        // ç»˜åˆ¶é€Ÿåº¦æŠ˜çº¿å›¾
        function drawSpeedChart(data, date) {
            console.log('drawSpeedChart è¢«è°ƒç”¨, data:', data, 'date:', date); // è°ƒè¯•ä¿¡æ¯
            
            const canvas = document.getElementById('speedChart');
            if (!canvas) {
                console.error('Canvas element not found!');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Cannot get 2d context!');
                return;
            }
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
            if (!data || data.length === 0) {
                console.warn('æ•°æ®ä¸ºç©ºï¼Œæ— æ³•ç»˜åˆ¶å›¾è¡¨');
                if (speedChart) {
                    speedChart.destroy();
                    speedChart = null;
                }
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (speedChart) {
                speedChart.destroy();
                speedChart = null;
            }

            // æ ¼å¼åŒ–æ ‡ç­¾ï¼šåªæ˜¾ç¤ºæ—¶é—´ï¼ˆHH:00, HH:20, æˆ– HH:40ï¼‰
            const labels = data.map(item => item.time);
            const counts = data.map(item => item.count);
            
            console.log('å›¾è¡¨æ•°æ® - labels:', labels.length, 'counts:', counts.length); // è°ƒè¯•ä¿¡æ¯

            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
            const dateParts = date.split('-');
            const dateDisplay = `${dateParts[1]}-${dateParts[2]}`;

            try {
                // æ£€æŸ¥ Chart æ˜¯å¦å¯ç”¨
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js æœªåŠ è½½ï¼');
                    return;
                }
                
                speedChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `æˆªå›¾æ•°é‡ï¼ˆ${dateDisplay}ï¼Œå¼ /20åˆ†é’Ÿï¼‰`,
                            data: counts,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `${dateDisplay} ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        return 'æˆªå›¾æ•°é‡: ' + context.parsed.y + ' å¼ /20åˆ†é’Ÿ';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´ï¼ˆæ¯20åˆ†é’Ÿï¼‰'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 5
                                },
                                title: {
                                    display: true,
                                    text: 'æ•°é‡ï¼ˆå¼ /20åˆ†é’Ÿï¼‰'
                                }
                            }
                        }
                    }
                });
                console.log('å›¾è¡¨åˆ›å»ºæˆåŠŸ'); // è°ƒè¯•ä¿¡æ¯
            } catch (error) {
                console.error('Error creating chart:', error);
                console.error('Error stack:', error.stack);
            }
        }
    </script>
</body>
</html>

